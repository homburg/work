deleteDependentEntities: true
createMissingRelatedEntities: true
enableMergeEntity: true
resources:
- kind: repository
  selector:
    query: 'true'
    teams: true
  port:
    entity:
      mappings:
        identifier: .full_name
        title: .name
        blueprint: '"githubRepository"'
        properties:
          readme: file://README.md
          url: .html_url
          defaultBranch: .default_branch
        relations:
          githubTeams: '[.teams[].id | tostring]'
- kind: pull-request
  selector:
    query: 'true'
  port:
    entity:
      mappings:
        identifier: .id|tostring
        title: .title
        blueprint: '"githubPullRequest"'
        properties:
          status: .status
          closedAt: .closed_at
          updatedAt: .updated_at
          mergedAt: .merged_at
          createdAt: .created_at
          prNumber: .number
          link: .html_url
          branch: .head.ref
          leadTimeHours: (.created_at as $createdAt | .merged_at as $mergedAt | ($createdAt | sub("\\..*Z$"; "Z") | strptime("%Y-%m-%dT%H:%M:%SZ") | mktime) as $createdTimestamp | ($mergedAt | if . == null then null else sub("\\..*Z$"; "Z") | strptime("%Y-%m-%dT%H:%M:%SZ") | mktime end) as $mergedTimestamp | if $mergedTimestamp == null then null else (((($mergedTimestamp - $createdTimestamp) / 3600) * 100 | floor) / 100) end)
- kind: user
  selector:
    query: 'true'
  port:
    entity:
      mappings:
        identifier: .login
        title: .login
        blueprint: '"githubUser"'
- kind: pull-request
  selector:
    query: 'true'
  port:
    entity:
      mappings:
        identifier: .user.login
        title: .user.login
        blueprint: '"githubUser"'
- kind: pull-request
  selector:
    query: 'true'
  port:
    entity:
      mappings:
        identifier: .id|tostring
        blueprint: '"githubPullRequest"'
        relations:
          repository: .head.repo.full_name
          git_hub_assignees: '[.assignees[].login]'
          git_hub_reviewers: '[.requested_reviewers[].login]'
          git_hub_creator: .user.login
          creator:
            combinator: '"and"'
            rules:
            - property: '"git_hub_username"'
              operator: '"="'
              value: .user.login
          service:
            combinator: '"and"'
            rules:
            - property: '"repo_id"'
              operator: '"="'
              value: .head.repo.full_name
          reviewers:
            combinator: '"and"'
            rules:
            - property: '"git_hub_username"'
              operator: '"in"'
              value: '[.requested_reviewers[].login]'
          assignees:
            combinator: '"and"'
            rules:
            - property: '"git_hub_username"'
              operator: '"in"'
              value: '[.assignees[].login]'
- kind: team
  selector:
    query: 'true'
  port:
    entity:
      mappings:
        identifier: .id | tostring
        title: .name
        blueprint: '"githubTeam"'
        properties:
          slug: .slug
          description: .description
          link: .html_url
          permission: .permission
          notification_setting: .notification_setting
- kind: folder
  selector:
    query: "true"
    folders:
    # Specify the repositories and folders to include under this relative path
    - path: apps/* # Relative path to the folders within the repositories
      repos:
      # List of repositories to include folders from
      - work
  port:
    entity:
      mappings:
        identifier: ".folder.name"
        title: ".folder.name"
        blueprint: '"service"'
        relations: {}
